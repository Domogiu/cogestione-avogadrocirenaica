<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cogestione Studentesca</title>
<style>
body { font-family: Arial,sans-serif; background:#f4f4f4; padding:20px; }
.card { background:#fff; padding:15px; margin-bottom:12px; border-radius:8px; }
button { padding:8px 12px; border:none; border-radius:6px; background:#007bff; color:#fff; cursor:pointer; }
button:disabled { background:#aaa; }
input, select { width:100%; padding:8px; margin:6px 0; }
.orario-menu { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; }
.orario-btn { padding:6px 10px; border:1px solid #007bff; border-radius:6px; cursor:pointer; }
.orario-btn.disabled { opacity:0.4; pointer-events:none; }
.floating-admin { position:fixed; bottom:20px; right:20px; }
.course-disabled { opacity:0.4; pointer-events:none; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>
<h1>Cogestione Studentesca Cirenaica</h1>
<div id="app"></div>
<button class="floating-admin" id="adminBtn">Admin</button>

<script>
/* CONFIG FIREBASE */
const ADMIN_PASSWORD_HASH =
  "4efff34f332ff7c913c6aaeaa3561aabf4030b4f391b987131a8c5f49c820b95"; 
const firebaseConfig = {
  apiKey: "AIzaSyAt21j06RBBODY2_xi2hzwOTAuEtYSZMB0",
  authDomain: "cirenaica-ad0ef.firebaseapp.com",
  databaseURL: "https://cirenaica-ad0ef-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "cirenaica-ad0ef",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
// ðŸ” Funzione hash SHA-256
async function sha256(text) {
  const encoder = new TextEncoder();
  const data = encoder.encode(text);
  const hashBuffer = await crypto.subtle.digest("SHA-256", data);
  return Array.from(new Uint8Array(hashBuffer))
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}
async function checkAdmin() {
  const p = prompt("Password admin");
  if (!p) return;

  const inputHash = await sha256(p);

  if (inputHash === ADMIN_PASSWORD_HASH) {
    adminFrom = utente ? "home" : "login";
    view = "admin";
    render();
  } else {
    alert("Password errata");
  }
}

// âœ… COLLEGA IL BOTTONE
document.getElementById("adminBtn").addEventListener("click", checkAdmin);
// Listener globale per lo stato iscrizioni
db.ref("iscrizioniBloccate").on("value", snap => {
  iscrizioniBloccate = snap.val() || false; // aggiorna la variabile locale
  render(); // aggiorna la vista su tutti i dispositivi
});
  
/* STATE */
let studenti={}, corsi={}, registrazioni={}, giornoStudente="Giorno 1", utente=null, view="login", filtroOrario=null;
let adminFrom = "login"; // memorizza la provenienza dell'area admin
let iscrizioniBloccate = false; // false = iscrizioni aperte, true = blocco attivo
let loginMode = "login"; // "login" | "register"  
/* REALTIME DATABASE LISTENER */
db.ref().on("value", snap=>{
  const d = snap.val() || {};
  studenti = d.studenti || {};
  corsi = d.corsi || {};
  registrazioni = d.registrazioni || {};
  giornoStudente = d.giornoStudente || "Giorno 1";

  // ðŸ”’ BLOCCA RERENDER DURANTE LOGIN / REGISTRAZIONE
  if (view !== "login") {
    render();
  }
});

/* RENDER PRINCIPALE */
function render(){
  if(view==="login") renderLogin();
  else if(view==="home") renderHome();
  else if(view==="admin") renderAdmin();
}

/* LOGIN STUDENTE */
function renderLogin() {
  if (loginMode === "login") {
    document.getElementById("app").innerHTML = `
      <div class="card">
        <h2>Login Studente</h2>
        <input id="email" placeholder="nome.cognome.s@liceoavogadro.onmicrosoft.com">
        <input id="password" type="password" placeholder="Password">
        <button onclick="login()">Accedi</button>
        <hr>
        <button onclick="loginMode='register'; render()">Registrati</button>
      </div>`;
  } else {
    document.getElementById("app").innerHTML = `
      <div class="card">
        <h2>Registrazione</h2>
        <input id="nomeReg" placeholder="Nome">
        <input id="cognomeReg" placeholder="Cognome">
        <input id="classeReg" placeholder="Classe">
        <input id="emailReg" placeholder="nome.cognome.s@liceoavogadro.onmicrosoft.com">
        <input id="passwordReg" type="password" placeholder="Password">
        <button onclick="registrati()">Registrati</button>
        <hr>
        <button onclick="loginMode='login'; render()">Torna al login</button>
      </div>`;
  }
}
  function registrati() {
  const nome = nomeReg.value.trim();
  const cognome = cognomeReg.value.trim();
  const classe = classeReg.value.trim();
  const email = emailReg.value.trim().toLowerCase();
  const password = passwordReg.value;

  if (!nome || !cognome || !classe || !email || !password)
    return alert("Completa tutti i campi");

  const esiste = Object.values(studenti).some(s => s.email === email);
  if (esiste) return alert("Email giÃ  registrata");

  const id = Date.now().toString();

  db.ref("studenti/" + id).set({
    nome, cognome, classe, email, password
  }).then(() => {
    alert("Registrazione completata");
    loginMode = "login";
    render();
  });
}
function login() {
  const email = document.getElementById("email").value.trim().toLowerCase();
  const password = document.getElementById("password").value;

  const found = Object.entries(studenti)
    .find(([_, s]) => s.email === email && s.password === password);

  if (!found) return alert("Credenziali errate");

  utente = { ...found[1], id: found[0] };
  view = "home";
  render();
}
/* HOME STUDENTE */
function renderHome(){
  let html=`<h3>Ciao ${utente.nome} ${utente.cognome}</h3>
  <button onclick="logout()">Logout</button><br><br>`;

  const lista=Object.entries(corsi)
    .filter(([id,c])=>c.giorno===giornoStudente)
    .sort((a,b)=>a[1].inizio.localeCompare(b[1].inizio));

 const orari = [...new Set(lista.map(([id,c]) => c.inizio))]
  .sort((a, b) => {
    const [ah, am] = a.split(':').map(Number);
    const [bh, bm] = b.split(':').map(Number);
    return ah * 60 + am - (bh * 60 + bm);
  });

html += `<div class="orario-menu">
  <div class="orario-btn ${!filtroOrario ? 'disabled' : ''}" onclick="filtroOrario=null;render()">Tutti</div>`;
orari.forEach(o => 
  html += `<div class="orario-btn ${filtroOrario===o ? 'disabled' : ''}" onclick="filtroOrario='${o}';render()">${o}</div>`
);
html += `</div>`;

 lista.forEach(([id, c]) => {
    if (filtroOrario && c.inizio !== filtroOrario) return;

    const iscritti = registrazioni[id] || [];
    const iscritto = iscritti.includes(utente.nome + " " + utente.cognome);
    const pieno = c.max && iscritti.length >= c.max;

    let overlap = false;
    Object.entries(registrazioni).forEach(([cid, arr]) => {
        if (arr.includes(utente.nome + " " + utente.cognome)) {
            const cc = corsi[cid];
            if (cc.giorno === c.giorno && !(c.fine <= cc.inizio || cc.fine <= c.inizio) && id !== cid) {
                overlap = true;
            }
        }
    });

    let cardClass = '';
    let buttonHtml = '';

    if (iscrizioniBloccate) {
        cardClass = iscritto ? '' : 'course-disabled';
        buttonHtml = `<button disabled>${iscritto ? "Iscrizione bloccata" : "Iscrizioni bloccate"}</button>`;
    } else {
        cardClass = (pieno && !iscritto || overlap) ? 'course-disabled' : '';
        if (iscritto) {
            buttonHtml = `<button onclick="annulla('${id}')">Annulla iscrizione</button>`;
        } else {
            buttonHtml = `<button onclick="iscrivi('${id}')" ${pieno || overlap ? 'disabled' : ''}>Iscriviti</button>`;
        }
    }

    html += `
    <div class="card ${cardClass}">
        <h3>${c.nome}</h3>
        <p>${c.giorno} ${c.inizio}-${c.fine} | Aula: ${c.aula || 'N/A'} | Docente: ${c.docente || 'N/A'}</p>
        <p>${c.descrizione || ''}</p>
        ${buttonHtml}
    </div>`;
});
  document.getElementById("app").innerHTML = html;
}
function logout(){ utente=null; view="login"; render(); }

/* ISCRIZIONI */

function renderCorsi(){
  if(!utente) return;

  const key = utente.nome + " " + utente.cognome;

  let html = `<h2>Benvenuto, ${utente.nome} ${utente.cognome} (${utente.classe})</h2>
              <button onclick="logout()">Logout</button><br><br>`;

  const corsiGiorno = Object.entries(corsi).filter(([id,c])=>c.giorno===giornoStudente);

  const orari = [...new Set(corsiGiorno.map(([id,c])=>c.inizio))]
    .sort((a,b)=>timeToMinutes(a)-timeToMinutes(b));

  html += `<div class="orario-menu">
             <div class="orario-btn ${!filtroOrario?'disabled':''}"
                  onclick="filtroOrario=null; renderCorsi()">Tutti</div>`;
  orari.forEach(o=>{
    html += `<div class="orario-btn ${filtroOrario===o?'disabled':''}"
                  onclick="filtroOrario='${o}'; renderCorsi()">${o}</div>`;
  });
  html += `</div><br>`;

  corsiGiorno.forEach(([id,c])=>{
    if(filtroOrario && c.inizio!==filtroOrario) return;

    const iscritti = registrazioni[id] || [];
    const iscritto = iscritti.includes(key);
    const pieno = c.max && iscritti.length >= c.max;

    let disabledByOverlap = false;

    for(const cid in registrazioni){
      if(registrazioni[cid].includes(key)){
        const c2 = corsi[cid];
        if(!c2 || c2.giorno !== c.giorno) continue;

        const s1=timeToMinutes(c.inizio);
        const e1=timeToMinutes(c.fine);
        const s2=timeToMinutes(c2.inizio);
        const e2=timeToMinutes(c2.fine);

        if(!(e1<=s2 || e2<=s1)){
          disabledByOverlap = true;
          break;
        }
      }
    }

    html += `
      <div class="card course-container ${(disabledByOverlap&&!iscritto)||pieno?'disabled':''}">
        <h3>${c.nome}</h3>
        <p>${c.giorno} | ${c.inizio}-${c.fine} | Aula:${c.aula||'N/A'} | Docente:${c.docente||'N/A'}</p>
        <p>${c.descrizione||''}</p>

        ${
          iscritto
            ? `<button onclick="annulla('${id}')">Annulla iscrizione</button>`
            : `<button ${(disabledByOverlap||pieno)?'disabled':''}
                 onclick="iscrivi('${id}')">Iscriviti</button>`
        }

        ${pieno&&!iscritto?'<div class="course-full">Corso pieno</div>':''}
      </div>`;
  });

  document.getElementById("app").innerHTML = html;
}

function iscrivi(id){
  const key = utente.nome + " " + utente.cognome;
  const corso = corsi[id];
  if(!corso) return alert("Corso non trovato");

  for(const cid in registrazioni){
    if(registrazioni[cid].includes(key)){
      const c2 = corsi[cid];
      if(!c2 || c2.giorno !== corso.giorno) continue;

      if(!(corso.fine<=c2.inizio || c2.fine<=corso.inizio)){
        return alert("Non puoi iscriverti a piÃ¹ corsi nello stesso orario");
      }
    }
  }

  if(!registrazioni[id]) registrazioni[id]=[];
  if(registrazioni[id].includes(key)) return alert("Sei giÃ  iscritto");
  if(corso.max && registrazioni[id].length>=corso.max) return alert("Posti esauriti");

  registrazioni[id].push(key);
  db.ref("registrazioni/"+id).set(registrazioni[id])
    .then(()=>renderCorsi());
}


function annulla(id){
  const key=utente.nome+" "+utente.cognome;
  const arr=(registrazioni[id]||[]).filter(x=>x!==key);
  db.ref("registrazioni/"+id).set(arr);
}

/* ADMIN */
function renderAdmin(){
  let html=`<h2>Area Admin</h2>
  <button style="background:#dc3545;color:white" onclick="toggleIscrizioni()">
  Blocca/Riavvia iscrizioni
  </button><br><br>
  <button onclick="tornaAlMenu()">Torna al menu</button>
  <div class="card">
  <h3>Giorno visibile agli studenti</h3>
  <select id="giornoSelect"><option>Giorno 1</option><option>Giorno 2</option><option>Giorno 3</option></select>
  <button onclick="impostaGiorno()">Imposta</button>
  </div>
  
  <div class="card">
      <h3>Studenti registrati</h3>
      <ul id="studentList"></ul>
  </div>;

  <div class="card">
  <h3>Aggiungi Corso</h3>
  <input id="cn" placeholder="Nome"><input id="ci" placeholder="Inizio">
  <input id="cf" placeholder="Fine"><input id="ca" placeholder="Aula">
  <input id="cd" placeholder="Docente"><input id="cdesc" placeholder="Descrizione">
  <input id="cmax" placeholder="Max partecipanti">
  <select id="cg"><option>Giorno 1</option><option>Giorno 2</option><option>Giorno 3</option></select>
  <button onclick="addCorso()">Aggiungi</button>
  <ul id="courseList"></ul></div>

  <div class="card">
  <h3>Ricerca Studente</h3>
  <input id="rs" placeholder="Nome o cognome"><button onclick="cercaStudente()">Cerca</button>
  <div id="res"></div></div>`;
  document.getElementById("app").innerHTML = html;
  document.getElementById("giornoSelect").value = giornoStudente;
  renderStudentList(); renderCourseList(); renderStudentList();
}

/* FUNZIONI ADMIN */
function tornaAlMenu(){
  if(adminFrom === "home") {
    view = "home";   // torna alla schermata corsi dello studente
  } else {
    view = "login";  // torna al login
  }
  render();
}
function impostaGiorno() {
  const nuovoGiorno = document.getElementById("giornoSelect").value;
  giornoStudente = nuovoGiorno;         // Aggiorna subito la variabile locale
  db.ref("giornoStudente").set(nuovoGiorno)
    .then(() => render());               // Rerender per aggiornare subito la vista
  }
function renderStudentList(){
  const ul = document.getElementById("studentList");
  if (!ul) return;

  ul.innerHTML = "";

  Object.entries(studenti).forEach(([id, s]) => {
    const li = document.createElement("li");
    li.innerHTML = `
      ${s.nome} ${s.cognome} (${s.classe}) â€“ ${s.email || "email non presente"}
      <br>
      <button onclick="modStudent('${id}')">Modifica</button>
      <button style="background:#dc3545;color:white" onclick="deleteStudent('${id}')">Elimina</button>
    `;
    ul.appendChild(li);
  });

  if (ul.innerHTML === "") {
    ul.innerHTML = "<li>Nessuno studente registrato</li>";
  }
}

function modStudent(id){
  const s = studenti[id];
  if (!s) return;

  const n = prompt("Nome", s.nome);
  const c = prompt("Cognome", s.cognome);
  const l = prompt("Classe", s.classe);
  const p = prompt("Nuova password", s.password);

  db.ref("studenti/" + id).set({
    ...s,
    nome: n || s.nome,
    cognome: c || s.cognome,
    classe: l || s.classe,
    password: p || s.password
  });
}

function deleteStudent(id){
  if (!confirm("Sei sicuro di voler eliminare questo studente?")) return;

  const nomeCompleto = studenti[id].nome + " " + studenti[id].cognome;

  // elimina studente
  db.ref("studenti/" + id).remove();

  // rimuove lo studente da tutte le iscrizioni ai corsi
  Object.keys(registrazioni).forEach(cid => {
    const arr = (registrazioni[cid] || []).filter(n => n !== nomeCompleto);
    db.ref("registrazioni/" + cid).set(arr);
  });
}
function addCorso(){
  const cn=document.getElementById("cn").value.trim(); const ci=document.getElementById("ci").value.trim();
  const cf=document.getElementById("cf").value.trim(); const ca=document.getElementById("ca").value.trim();
  const cd=document.getElementById("cd").value.trim(); const cdesc=document.getElementById("cdesc").value.trim();
  const cmax=parseInt(document.getElementById("cmax").value); const cg=document.getElementById("cg").value;
  if(!cn||!ci||!cf||!cmax) return alert("Compila nome, orari e max");
  const id=Date.now(); db.ref("corsi/"+id).set({id,nome:cn,inizio:ci,fine:cf,aula:ca,docente:cd,descrizione:cdesc,max:cmax,giorno:cg});
  document.getElementById("cn").value=document.getElementById("ci").value=document.getElementById("cf").value=document.getElementById("ca").value=document.getElementById("cd").value=document.getElementById("cdesc").value=document.getElementById("cmax").value="";
}
function renderCourseList(){
  const ul = document.getElementById("courseList");
  ul.innerHTML = "";

  Object.entries(corsi).forEach(([id, c]) => {
    const iscritti = registrazioni[id] || [];

    const li = document.createElement("li");
    li.innerHTML = `
      <b>${c.nome}</b> (${c.giorno} ${c.inizio}-${c.fine})<br>
      Aula: ${c.aula || "N/A"} | Docente: ${c.docente || "N/A"} | Max: ${c.max || "âˆž"}<br>
      Iscritti: ${iscritti.length ? iscritti.join(", ") : "Nessuno"}<br>
      <button onclick="modCourse('${id}')">Modifica</button>
      <button style="background:#dc3545;color:white" onclick="deleteCourse('${id}')">Elimina</button>
    `;

    ul.appendChild(li);
  });
}

function deleteCourse(id){
  if (!confirm("Sei sicuro di voler eliminare questo corso?")) return;

  firebase.database().ref("corsi/" + id).remove();
  firebase.database().ref("registrazioni/" + id).remove();
}
function modCourse(id){
  const c=corsi[id];
  const n=prompt("Nome",c.nome); const ci=prompt("Inizio",c.inizio);
  const cf=prompt("Fine",c.fine); const ca=prompt("Aula",c.aula);
  const cd=prompt("Docente",c.docente); const desc=prompt("Descrizione",c.descrizione);
  const max=parseInt(prompt("Max partecipanti",c.max)); const g=prompt("Giorno",c.giorno);
  db.ref("corsi/"+id).set({id,nome:n||c.nome,inizio:ci||c.inizio,fine:cf||c.fine,aula:ca||c.aula,docente:cd||c.docente,descrizione:desc||c.descrizione,max:max||c.max,giorno:g||c.giorno});
}
// Listener globale per aggiornare lo stato delle iscrizioni
db.ref("iscrizioniBloccate").on("value", snap => {
  iscrizioniBloccate = snap.val() || false;
});

function toggleIscrizioni() {
  const nuovoStato = !iscrizioniBloccate;
  db.ref("iscrizioniBloccate").set(nuovoStato)
    .then(() => {
      alert("Iscrizioni " + (nuovoStato ? "bloccate" : "riattivate"));
    })
    .catch(err => {
      console.error("Errore nel blocco/riavvio iscrizioni:", err);
      alert("Errore durante il cambio dello stato delle iscrizioni.");
    });
  }
/* RICERCA */
function cercaStudente(){
  const val=document.getElementById("rs").value.toLowerCase(); let out="";
  Object.entries(registrazioni).forEach(([id,arr])=>{
    arr.forEach(n=>{
      if(n.toLowerCase().includes(val)){
        const c=corsi[id]; if(c) out+=`<p>${n} â†’ ${c.nome} (${c.giorno} ${c.inizio}-${c.fine})</p>`;
      }
    });
  }); document.getElementById("res").innerHTML=out||"Nessun risultato";
}
</script>
</body>
</html>
