<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cogestione Studentesca Brenta</title>
<style>
body { font-family: Arial,sans-serif; background:#f4f4f4; padding:20px; }
.card { background:#fff; padding:15px; margin-bottom:12px; border-radius:8px; }
button { padding:8px 12px; border:none; border-radius:6px; background:#007bff; color:#fff; cursor:pointer; }
button:disabled { background:#aaa; }
input, select { width:100%; padding:8px; margin:6px 0; }
.orario-menu { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; }
.orario-btn { padding:6px 10px; border:1px solid #007bff; border-radius:6px; cursor:pointer; }
.orario-btn.disabled { opacity:0.4; pointer-events:none; }
.floating-admin { position:fixed; bottom:20px; right:20px; }
.course-disabled { opacity:0.4; pointer-events:none; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>
<h1>Cogestione Studentesca Brenta</h1>
<div id="app"></div>
<button class="floating-admin" onclick="checkAdmin()">Admin</button>

<script>
/* CONFIG FIREBASE */
const ADMIN_PASSWORD = "avogadro@2025";
const firebaseConfig = {
  apiKey: "AIzaSyAt21j06RBBODY2_xi2hzwOTAuEtYSZMB0",
  authDomain: "cirenaica-ad0ef.firebaseapp.com",
  databaseURL: "https://cirenaica-ad0ef-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "cirenaica-ad0ef",
  storageBucket: "cirenaica-ad0ef.appspot.com",
  messagingSenderId: "425526095320",
  appId: "1:425526095320:web:68311468eb8c25496056ad",
  measurementId: "G-4DFP9YM9VM"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* STATE */
let studenti={}, corsi={}, registrazioni={}, giornoStudente="Giorno 1", utente=null, view="login", filtroOrario=null;
let adminFrom = "login"; 
let iscrizioniBloccate = false;

/* LISTENER GLOBALE PER ISCRIZIONI BLOCCATE */
db.ref("iscrizioniBloccate").on("value", snap => {
  iscrizioniBloccate = snap.val() || false;
  render();
});

/* REALTIME DATABASE LISTENER */
db.ref().on("value", snap=>{
  const d = snap.val() || {};
  studenti = d.studenti || {};
  corsi = d.corsi || {};
  registrazioni = d.registrazioni || {};
  giornoStudente = d.giornoStudente || "Giorno 1";
  render();
});

/* RENDER PRINCIPALE */
function render(){
  if(view==="login") renderLogin();
  else if(view==="home") renderHome();
  else if(view==="admin") renderAdmin();
}

/* LOGIN E REGISTRAZIONE */
function renderLogin() {
  if (loginMode === "login") {
    document.getElementById("app").innerHTML = `
      <div class="card">
        <h2>Login Studente</h2>
        <input id="email" placeholder="nome.cognome.s@liceobrenta.onmicrosoft.com">
        <input id="password" type="password" placeholder="Password">
        <button onclick="login()">Accedi</button>
        <hr>
        <button onclick="loginMode='register'; render()">Registrati</button>
      </div>`;
  } else {
    document.getElementById("app").innerHTML = `
      <div class="card">
        <h2>Registrazione</h2>
        <input id="nomeReg" placeholder="Nome">
        <input id="cognomeReg" placeholder="Cognome">
        <input id="classeReg" placeholder="Classe">
        <input id="emailReg" placeholder="nome.cognome.s@liceobrenta.onmicrosoft.com">
        <input id="passwordReg" type="password" placeholder="Password">
        <button onclick="registrati()">Registrati</button>
        <hr>
        <button onclick="loginMode='login'; render()">Torna al login</button>
      </div>`;
  }
}
function registrati() {
  const nome = nomeReg.value.trim();
  const cognome = cognomeReg.value.trim();
  const classe = classeReg.value.trim();
  const email = emailReg.value.trim().toLowerCase();
  const password = passwordReg.value;
  if (!nome || !cognome || !classe || !email || !password)
    return alert("Completa tutti i campi");
  const esiste = Object.values(studenti).some(s => s.email === email);
  if (esiste) return alert("Email già registrata");
  const id = Date.now().toString();
  db.ref("studenti/" + id).set({ nome, cognome, classe, email, password })
    .then(() => { alert("Registrazione completata"); loginMode = "login"; render(); });
}
function login() {
  const email = document.getElementById("email").value.trim().toLowerCase();
  const password = document.getElementById("password").value;
  const found = Object.entries(studenti).find(([_, s]) => s.email === email && s.password === password);
  if (!found) return alert("Credenziali errate");
  utente = { ...found[1], id: found[0] };
  view = "home";
  render();
}

/* HOME STUDENTE */
function renderHome(){
  let html=`<h3>Ciao ${utente.nome} ${utente.cognome}</h3>
  <button onclick="logout()">Logout</button><br><br>`;
  const lista=Object.entries(corsi).filter(([id,c])=>c.giorno===giornoStudente)
               .sort((a,b)=>a[1].inizio.localeCompare(b[1].inizio));
  const orari = [...new Set(lista.map(([id,c]) => c.inizio))].sort((a,b)=>timeToMinutes(a)-timeToMinutes(b));
  html += `<div class="orario-menu"><div class="orario-btn ${!filtroOrario?'disabled':''}" onclick="filtroOrario=null;render()">Tutti</div>`;
  orari.forEach(o => html += `<div class="orario-btn ${filtroOrario===o?'disabled':''}" onclick="filtroOrario='${o}';render()">${o}</div>`);
  html += `</div>`;

  lista.forEach(([id, c]) => {
    if(filtroOrario && c.inizio!==filtroOrario) return;
    const iscritti = registrazioni[id] || [];
    const iscritto = iscritti.includes(utente.nome + " " + utente.cognome);
    const pieno = c.max && iscritti.length >= c.max;
    let overlap = false;
    Object.entries(registrazioni).forEach(([cid, arr])=>{
      if(arr.includes(utente.nome + " " + utente.cognome)){
        const cc = corsi[cid];
        if(cc.giorno===c.giorno && !(c.fine<=cc.inizio || cc.fine<=c.inizio) && id!==cid) overlap=true;
      }
    });

    let cardClass='', buttonHtml='';
    if(iscrizioniBloccate){
      cardClass = iscritto ? '' : 'course-disabled';
      buttonHtml = `<button disabled>${iscritto?"Annulla iscrizione":"Iscrizioni bloccate"}</button>`;
    } else {
      cardClass = (pieno && !iscritto || overlap)?'course-disabled':'';
      buttonHtml = iscritto ? `<button onclick="annulla('${id}')">Annulla iscrizione</button>` : `<button onclick="iscrivi('${id}')" ${pieno||overlap?'disabled':''}>Iscriviti</button>`;
    }

    html += `<div class="card ${cardClass}">
      <h3>${c.nome}</h3>
      <p>${c.giorno} ${c.inizio}-${c.fine} | Aula: ${c.aula||'N/A'} | Docente: ${c.docente||'N/A'}</p>
      <p>${c.descrizione||''}</p>
      ${buttonHtml}
    </div>`;
  });

  document.getElementById("app").innerHTML = html;
}

function logout(){ utente=null; view="login"; render(); }

/* FUNZIONI UTILI */
function timeToMinutes(t){ const [h,m]=t.split(":").map(Number); return h*60+m; }

function iscrivi(id){
  const key = utente.nome + " " + utente.cognome;
  const corso = corsi[id]; if(!corso) return alert("Corso non trovato");
  for(const cid in registrazioni){
    if(registrazioni[cid].includes(key)){
      const c2=corsi[cid]; if(!c2 || c2.giorno!==corso.giorno) continue;
      if(!(corso.fine<=c2.inizio || c2.fine<=corso.inizio)) return alert("Non puoi iscriverti a più corsi nello stesso orario");
    }
  }
  if(!registrazioni[id]) registrazioni[id]=[];
  if(registrazioni[id].includes(key)) return alert("Sei già iscritto");
  if(corso.max && registrazioni[id].length>=corso.max) return alert("Posti esauriti");
  registrazioni[id].push(key);
  db.ref("registrazioni/"+id).set(registrazioni[id]).then(()=>renderHome());
}

function annulla(id){
  const key = utente.nome + " " + utente.cognome;
  const arr = (registrazioni[id]||[]).filter(x=>x!==key);
  db.ref("registrazioni/"+id).set(arr).then(()=>renderHome());
}

/* ADMIN */
function checkAdmin(){
  const p = prompt("Password admin");
  if(p===ADMIN_PASSWORD){ adminFrom=utente?"home":"login"; view="admin"; render(); }
  else alert("Password errata");
}
function toggleIscrizioni(){
  const nuovoStato = !iscrizioniBloccate;
  db.ref("iscrizioniBloccate").set(nuovoStato)
    .then(()=>alert("Iscrizioni "+(nuovoStato?"bloccate":"riattivate")))
    .catch(err=>{ console.error(err); alert("Errore nel cambio stato iscrizioni"); });
}
</script>
</body>
</html>
